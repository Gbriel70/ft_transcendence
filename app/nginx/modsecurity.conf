# Habilitar ModSecurity
SecRuleEngine On

# Request body processing
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Response body processing
SecResponseBodyAccess Off

# Audit logging
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsec_audit.log
SecAuditLogParts ABIJDEFHZ

# Argumentos
SecArgumentSeparator &
SecCookieFormat 0

# Diretórios temporários
SecTmpDir /tmp/
SecDataDir /tmp/

# Incluir OWASP CRS
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
Include /etc/modsecurity.d/owasp-crs/rules/*.conf

# ===== REGRAS CUSTOMIZADAS (MAIS AGRESSIVAS) =====

# Bloquear SQL Injection
SecRule ARGS|REQUEST_BODY "@rx (?i:(union.*select|insert.*into|delete.*from|drop.*table|or\s+1\s*=\s*1|'.*or.*'.*=.*'))" \
    "id:1001,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'SQL Injection attempt detected',\
    severity:CRITICAL,\
    tag:'attack-sqli'"

# Bloquear XSS (mais abrangente)
SecRule ARGS|REQUEST_BODY "@rx (?i:(<script|</script|javascript:|onerror|onload|onclick|onmouseover|<iframe|eval\s*\(|alert\s*\(|document\.cookie|window\.location))" \
    "id:1002,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'XSS attempt detected',\
    severity:CRITICAL,\
    tag:'attack-xss'"

# Bloquear Path Traversal
SecRule ARGS|REQUEST_URI "@rx (?i:(\.\.\/|\.\.\\|%2e%2e))" \
    "id:1003,\
    phase:1,\
    deny,\
    status:403,\
    log,\
    msg:'Path traversal attempt',\
    severity:WARNING,\
    tag:'attack-traversal'"

# Bloquear comandos OS
SecRule ARGS|REQUEST_BODY "@rx (?i:(;|\||`|\$\(|<\(|>\(|&&|\|\||cat\s|wget\s|curl\s|bash\s|sh\s|nc\s))" \
    "id:1004,\
    phase:2,\
    deny,\
    status:403,\
    log,\
    msg:'OS command injection attempt',\
    severity:CRITICAL,\
    tag:'attack-rce'"