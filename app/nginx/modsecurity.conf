# Habilitar ModSecurity
SecRuleEngine On

# Request body processing
SecRequestBodyAccess On
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# Response body processing (desabilitado para performance)
SecResponseBodyAccess Off

# Audit logging - apenas ataques
SecAuditEngine RelevantOnly
SecAuditLog /var/log/modsec_audit.log
SecAuditLogParts ABIJDEFHZ

# Argumentos e encoding
SecArgumentSeparator &
SecCookieFormat 0

# Upload de arquivos
SecTmpDir /tmp/
SecDataDir /tmp/

# Debug (remover em produção)
SecDebugLog /var/log/modsec_debug.log
SecDebugLogLevel 0

# Incluir OWASP Core Rule Set (já vem na imagem)
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
Include /etc/modsecurity.d/owasp-crs/rules/*.conf

# ===== REGRAS CUSTOMIZADAS =====

# Bloquear SQL Injection
SecRule ARGS|REQUEST_BODY "@rx (?i:(\bunion\b.+\bselect\b|\binsert\b.+\binto\b|\bdelete\b.+\bfrom\b|\bdrop\b.+\btable\b))" \
    "id:1001,\
    phase:2,\
    block,\
    log,\
    msg:'SQL Injection attempt detected',\
    severity:CRITICAL,\
    tag:'attack-sqli'"

# Bloquear XSS
SecRule ARGS|REQUEST_BODY "@rx (?i:(<script|javascript:|onerror\s*=|onload\s*=|<iframe))" \
    "id:1002,\
    phase:2,\
    block,\
    log,\
    msg:'XSS attempt detected',\
    severity:CRITICAL,\
    tag:'attack-xss'"

# Bloquear Path Traversal
SecRule ARGS|REQUEST_URI "@rx (?i:(\.\.\/|\.\.\\))" \
    "id:1003,\
    phase:1,\
    block,\
    log,\
    msg:'Path traversal attempt',\
    severity:WARNING,\
    tag:'attack-traversal'"