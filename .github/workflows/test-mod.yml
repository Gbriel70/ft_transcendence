name: WAF/ModSecurity Tests

on:
  push:
    branches: [ main, auth ]
    paths:
      - 'app/nginx/**'
      - 'docker-compose.yml'
      - '.github/workflows/test-mod.yml'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-waf:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üê≥ Build and start services
        run: |
          docker compose up -d --build
          echo "Waiting for containers to start..."
          sleep 25

      - name: üîç Check container status
        run: |
          echo "=== Container Status ==="
          docker compose ps
          echo ""
          echo "=== Running Containers ==="
          docker ps

      - name: ‚è≥ Wait for NGINX to be healthy
        run: |
          echo "Waiting for NGINX..."
          for i in {1..30}; do
            if docker exec nginx nginx -t 2>&1 | grep -q "successful"; then
              echo "‚úÖ NGINX is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

      - name: üîç Check ModSecurity is loaded
        run: |
          echo "Checking ModSecurity status..."
          
          # Verificar se as regras foram carregadas nos logs
          if docker logs nginx 2>&1 | grep -q "ModSecurity-nginx v"; then
            echo "‚úÖ ModSecurity detected in logs!"
            docker logs nginx 2>&1 | grep "ModSecurity-nginx"
          else
            echo "‚ùå ModSecurity NOT found in logs"
            docker logs nginx --tail=50
            exit 1
          fi
          
          # Verificar quantas regras foram carregadas
          rules=$(docker logs nginx 2>&1 | grep -oP 'rules loaded inline/local/remote: \K[0-9/]+' | head -1)
          echo "Rules loaded: $rules"
          
          if [ ! -z "$rules" ]; then
            echo "‚úÖ ModSecurity rules successfully loaded"
          else
            echo "‚ùå No rules loaded"
            exit 1
          fi

      - name: üõ°Ô∏è Test SQL Injection Protection
        run: |
          echo "Testing SQL Injection block..."
          
          response=$(curl -k -s -o /dev/null -w "%{http_code}" -X POST \
            https://localhost:8443/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"admin@test.com OR 1=1-- ","password":"test"}')
          
          echo "Response code: $response"
          
          if [ "$response" == "403" ] || [ "$response" == "401" ]; then
            echo "‚úÖ SQL Injection blocked or rejected (code: $response)"
          else
            echo "‚ö†Ô∏è Got response: $response (expected 403 or 401)"
          fi

      - name: üõ°Ô∏è Test XSS Protection
        run: |
          echo "Testing XSS block..."
          
          response=$(curl -k -s -o /dev/null -w "%{http_code}" -X POST \
            https://localhost:8443/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"pass123","name":"<script>alert(1)</script>"}')
          
          echo "Response code: $response"
          
          if [ "$response" == "403" ]; then
            echo "‚úÖ XSS blocked (403)"
          else
            echo "‚ö†Ô∏è Got response: $response (expected 403)"
          fi

      - name: üõ°Ô∏è Test Rate Limiting
        run: |
          echo "Testing rate limiting on login endpoint..."
          
          for i in {1..7}; do
            code=$(curl -k -s -o /dev/null -w "%{http_code}" -X POST \
              https://localhost:8443/api/auth/login \
              -H "Content-Type: application/json" \
              -d '{"email":"test@test.com","password":"wrong"}')
            
            echo "Request $i: HTTP $code"
            
            if [ $i -gt 5 ] && [ "$code" == "503" ]; then
              echo "‚úÖ Rate limit working!"
              break
            fi
            
            sleep 0.5
          done

      - name: ‚úÖ Test Valid Registration
        run: |
          echo "Testing legitimate request..."
          
          unique_email="user$(date +%s)@test.com"
          
          response=$(curl -k -s -w "\n%{http_code}" -X POST \
            https://localhost:8443/api/auth/register \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$unique_email\",\"password\":\"SecurePass123\",\"name\":\"John Doe\"}")
          
          http_code=$(echo "$response" | tail -n1)
          
          echo "Response code: $http_code"
          
          if [ "$http_code" == "201" ]; then
            echo "‚úÖ Valid request allowed (201)"
          else
            echo "‚ö†Ô∏è Got response: $http_code"
          fi

      - name: üîç Check Security Headers
        run: |
          echo "Testing security headers..."
          
          headers=$(curl -k -s -I https://localhost:8443/)
          
          echo "$headers"
          echo ""
          
          echo "$headers" | grep -i "X-Frame-Options" && echo "‚úÖ X-Frame-Options present" || echo "‚ùå Missing"
          echo "$headers" | grep -i "X-Content-Type-Options" && echo "‚úÖ X-Content-Type-Options present" || echo "‚ùå Missing"
          echo "$headers" | grep -i "X-XSS-Protection" && echo "‚úÖ X-XSS-Protection present" || echo "‚ùå Missing"

      - name: üìã Show ModSecurity audit log
        if: always()
        run: |
          echo "üìã ModSecurity audit log:"
          docker exec nginx cat /var/log/modsec_audit.log 2>/dev/null || echo "No audit log found (no attacks detected yet)"

      - name: üìã Show service logs
        if: always()
        run: |
          echo "=== NGINX Logs ==="
          docker logs nginx --tail=50 2>&1 || echo "nginx container not available"
          echo ""
          echo "=== Auth Service Logs ==="
          docker logs auth_service --tail=30 2>&1 || echo "auth_service not available"

      - name: üßπ Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f