name: Test Docker Infrastructure

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Permite rodar manualmente

jobs:
  test-docker-setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Check Docker Compose file
        run: |
          echo "ğŸ“‹ Validating docker-compose.yml..."
          docker compose config

      - name: ğŸ—ï¸ Build all containers
        run: |
          echo "ğŸ”¨ Building all services..."
          docker compose build --no-cache
        timeout-minutes: 15

      - name: ğŸš€ Start all services
        run: |
          echo "ğŸš€ Starting infrastructure..."
          docker compose up -d
        timeout-minutes: 5

      - name: â³ Wait for services to be healthy
        run: |
          echo "â³ Waiting for PostgreSQL to be healthy..."
          timeout 60 bash -c 'until docker compose ps | grep postgres | grep -q "healthy"; do sleep 2; done' || true
          
          echo "â³ Waiting 30s for all services to initialize..."
          sleep 30

      - name: ğŸ“Š Show running containers
        run: |
          echo "ğŸ“Š Container Status:"
          docker compose ps
          echo ""
          echo "ğŸŒ Networks:"
          docker network ls

      - name: ğŸ” Check PostgreSQL
        run: |
          echo "ğŸ” Testing PostgreSQL connection..."
          docker compose exec -T postgres pg_isready -U admin || {
            echo "âŒ PostgreSQL not ready"
            docker compose logs postgres
            exit 1
          }
          echo "âœ… PostgreSQL is healthy"

      - name: ğŸ§ª Test Auth Service
        run: |
          echo "ğŸ§ª Testing Auth Service (port 3001)..."
          
          # Test health endpoint
          response=$(docker compose exec -T auth_service wget -qO- http://localhost:3001/health 2>&1 || echo "failed")
          echo "Response: $response"
          
          if [[ "$response" == "failed" ]]; then
            echo "âŒ Auth service not responding"
            docker compose logs auth_service
            exit 1
          fi
          echo "âœ… Auth service is responding"

      - name: ğŸ§ª Test User Service
        run: |
          echo "ğŸ§ª Testing User Service (port 3002)..."
          
          response=$(docker compose exec -T user_service wget -qO- http://localhost:3002/health 2>&1 || echo "failed")
          echo "Response: $response"
          
          if [[ "$response" == "failed" ]]; then
            echo "âŒ User service not responding"
            docker compose logs user_service
            exit 1
          fi
          echo "âœ… User service is responding"

      - name: ğŸ§ª Test Transition Service
        run: |
          echo "ğŸ§ª Testing Transition Service (port 3003)..."
          
          response=$(docker compose exec -T transition_service wget -qO- http://localhost:3003/health 2>&1 || echo "failed")
          echo "Response: $response"
          
          if [[ "$response" == "failed" ]]; then
            echo "âŒ Transition service not responding"
            docker compose logs transition_service
            exit 1
          fi
          echo "âœ… Transition service is responding"

      - name: ğŸ§ª Test Blockchain Service
        run: |
          echo "ğŸ§ª Testing Blockchain Service (port 3004)..."
          
          response=$(docker compose exec -T blockchain_service wget -qO- http://localhost:3004/health 2>&1 || echo "failed")
          echo "Response: $response"
          
          if [[ "$response" == "failed" ]]; then
            echo "âŒ Blockchain service not responding"
            docker compose logs blockchain_service
            exit 1
          fi
          echo "âœ… Blockchain service is responding"

      - name: ğŸŒ Test Nginx Gateway
        run: |
          echo "ğŸŒ Testing Nginx reverse proxy..."
          
          # Test if nginx is running
          if ! docker compose ps nginx | grep -q "Up"; then
            echo "âŒ Nginx container is not running"
            docker compose logs nginx
            exit 1
          fi
          
          # Test routing to auth service through nginx
          echo "Testing /api/auth route..."
          curl -f http://localhost/api/auth/health || {
            echo "âŒ Nginx routing to auth failed"
            docker compose logs nginx
            exit 1
          }
          
          # Test routing to user service
          echo "Testing /api/user route..."
          curl -f http://localhost/api/user/health || {
            echo "âŒ Nginx routing to user failed"
            docker compose logs nginx
            exit 1
          }
          
          echo "âœ… Nginx routing is working"

      - name: ğŸ¨ Test Frontend
        run: |
          echo "ğŸ¨ Testing Frontend..."
          
          # Check if frontend is serving content
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/)
          
          if [[ "$response" != "200" ]]; then
            echo "âŒ Frontend not responding (HTTP $response)"
            docker compose logs frontend
            exit 1
          fi
          
          echo "âœ… Frontend is serving content"

      - name: ğŸ—„ï¸ Test Database Schemas
        run: |
          echo "ğŸ—„ï¸ Checking database schemas..."
          
          docker compose exec -T postgres psql -U admin -d minibank_db -c "\dn" || {
            echo "âŒ Failed to query database schemas"
            docker compose logs postgres
            exit 1
          }
          
          echo "âœ… Database schemas are accessible"

      - name: ğŸ”„ Test Service Communication
        run: |
          echo "ğŸ”„ Testing service-to-service communication..."
          
          # Test if auth service can connect to postgres
          docker compose exec -T auth_service sh -c 'nc -zv postgres 5432' || {
            echo "âš ï¸ Auth service cannot reach PostgreSQL"
          }
          
          echo "âœ… Service communication test complete"

      - name: ğŸ“‹ Show service logs (last 50 lines)
        if: always()
        run: |
          echo "ğŸ“‹ Recent logs from all services:"
          echo ""
          echo "=== POSTGRES ==="
          docker compose logs --tail=50 postgres || true
          echo ""
          echo "=== AUTH SERVICE ==="
          docker compose logs --tail=50 auth_service || true
          echo ""
          echo "=== USER SERVICE ==="
          docker compose logs --tail=50 user_service || true
          echo ""
          echo "=== TRANSITION SERVICE ==="
          docker compose logs --tail=50 transition_service || true
          echo ""
          echo "=== BLOCKCHAIN SERVICE ==="
          docker compose logs --tail=50 blockchain_service || true
          echo ""
          echo "=== NGINX ==="
          docker compose logs --tail=50 nginx || true
          echo ""
          echo "=== FRONTEND ==="
          docker compose logs --tail=50 frontend || true

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          docker compose down -v
          docker system prune -f

  test-individual-builds:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: auth
            path: ./app/services/auth
          - name: user
            path: ./app/services/user
          - name: transition
            path: ./app/services/transition
          - name: blockchain
            path: ./app/services/blockchain
          - name: frontend
            path: ./app/frontend
          - name: nginx
            path: ./app/nginx
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Build ${{ matrix.service.name }} service
        run: |
          echo "ğŸ”¨ Building ${{ matrix.service.name }} service..."
          docker build -t test-${{ matrix.service.name }} -f ${{ matrix.service.path }}/dockerfile ${{ matrix.service.path }} || {
            echo "âŒ Failed to build ${{ matrix.service.name }}"
            exit 1
          }
          echo "âœ… ${{ matrix.service.name }} built successfully"

      - name: ğŸ” Inspect image
        run: |
          echo "ğŸ” Image details:"
          docker images test-${{ matrix.service.name }}
          docker inspect test-${{ matrix.service.name }} | grep -A 5 "ExposedPorts" || true