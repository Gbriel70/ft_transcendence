name: Vault Integration Tests

on:
  push:
    branches: [ main, vault ]
    paths:
      - 'app/vault/**'
      - 'app/services/**/vault.js'
      - 'docker-compose.yml'
      - '.github/workflows/vault_test.yml'
  pull_request:
    branches: [ main, vault ]
  workflow_dispatch:

jobs:
  test-vault:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Build and start services
        run: |
          docker compose up -d --build vault postgres
          echo "Waiting for initial services..."
          sleep 15

      - name: ðŸ” Check container status
        run: |
          echo "=== Container Status ==="
          docker compose ps
          echo ""
          echo "=== Vault Logs ==="
          docker logs vault --tail=20
          echo ""
          echo "=== Postgres Logs ==="
          docker logs postgres --tail=10

      - name: â³ Wait for Vault to be ready
        run: |
          echo "Waiting for Vault..."
          for i in {1..30}; do
            if docker exec vault vault status 2>&1 | grep -q "Sealed.*false"; then
              echo "âœ… Vault is unsealed and ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 2
          done

      - name: ðŸ” Check Vault status
        run: |
          echo "Checking Vault status..."
          docker exec vault vault status

      - name: ðŸš€ Start vault-init to populate secrets
        run: |
          echo "Starting vault-init to create secrets..."
          docker compose up vault-init
          
          echo "Waiting for vault-init to complete..."
          sleep 5

      - name: ðŸ” Test Vault authentication
        run: |
          echo "Testing Vault token authentication..."
          
          response=$(docker exec vault vault kv get -format=json secret/auth 2>&1)
          
          if echo "$response" | grep -q "jwt_secret"; then
            echo "âœ… Successfully authenticated and retrieved auth secrets"
            echo "$response" | jq '.data.data'
          else
            echo "âŒ Failed to retrieve secrets"
            echo "$response"
            exit 1
          fi

      - name: ðŸ§ª Test all service secrets
        run: |
          echo "Testing secrets for all services..."
          
          # Auth service secrets
          echo "ðŸ“ Auth service secrets:"
          docker exec vault vault kv get secret/auth
          echo ""
          
          # User service secrets
          echo "ðŸ“ User service secrets:"
          docker exec vault vault kv get secret/user
          echo ""
          
          # Transition service secrets
          echo "ðŸ“ Transition service secrets:"
          docker exec vault vault kv get secret/transition
          echo ""
          
          # Blockchain service secrets
          echo "ðŸ“ Blockchain service secrets:"
          docker exec vault vault kv get secret/blockchain

      - name: ðŸ”— Build and start auth service
        run: |
          echo "Building and starting auth service..."
          docker compose up -d --build auth_service
          
          echo "Waiting for auth service to initialize..."
          sleep 15

      - name: ðŸ“‹ Check auth service logs
        run: |
          echo "=== Auth Service Logs ==="
          docker logs auth_service --tail=50

      - name: âœ… Verify auth service is running
        run: |
          if docker logs auth_service 2>&1 | grep -q "Auth service running"; then
            echo "âœ… Auth service connected to Vault and started successfully"
          else
            echo "âŒ Auth service failed to start properly"
            docker logs auth_service
            exit 1
          fi

      - name: ðŸ§ª Test auth service health endpoint
        run: |
          echo "Testing auth service health endpoint..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/health)
          
          echo "Health check response: $response"
          
          if [ "$response" == "200" ]; then
            echo "âœ… Auth service is healthy"
          else
            echo "âŒ Auth service health check failed"
            exit 1
          fi

      - name: ðŸ§ª Test user registration (Vault â†’ DB flow)
        run: |
          echo "Testing user registration (verifies Vault secrets work)..."
          
          unique_email="vault-test-$(date +%s)@test.com"
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            http://localhost:3001/register \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$unique_email\",\"password\":\"TestPass123\",\"name\":\"Vault Tester\"}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Response code: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" == "201" ]; then
            echo "âœ… Registration successful - Vault credentials work!"
            echo "$body" | jq '.'
          else
            echo "âŒ Registration failed"
            exit 1
          fi

      - name: ðŸ§ª Test user login
        run: |
          echo "Testing login with registered user..."
          
          # Use the user we just created
          unique_email="vault-test-$(date +%s)@test.com"
          
          # Register first
          curl -s -X POST http://localhost:3001/register \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$unique_email\",\"password\":\"TestPass123\",\"name\":\"Login Test\"}"
          
          # Now login
          response=$(curl -s -w "\n%{http_code}" -X POST \
            http://localhost:3001/login \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$unique_email\",\"password\":\"TestPass123\"}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "Response code: $http_code"
          echo "Response body: $body"
          
          if [ "$http_code" == "200" ]; then
            echo "âœ… Login successful"
            echo "$body" | jq '.token' | head -c 50
            echo "..."
          else
            echo "âŒ Login failed"
            exit 1
          fi

      - name: ðŸ”’ Test Vault seal status
        run: |
          echo "Testing Vault seal status..."
          
          status=$(docker exec vault vault status -format=json)
          
          echo "$status" | jq '.'
          
          if echo "$status" | grep -q '"sealed":false'; then
            echo "âœ… Vault is unsealed (as expected in dev mode)"
          else
            echo "âŒ Vault is sealed"
            exit 1
          fi

      - name: ðŸ“Š Show Vault metrics
        run: |
          echo "=== Vault Token Info ==="
          docker exec vault vault token lookup || echo "Token lookup not available"

      - name: ðŸ“‹ Show final logs
        if: always()
        run: |
          echo "=== Vault Logs ==="
          docker logs vault --tail=50
          echo ""
          echo "=== Vault Init Logs ==="
          docker logs vault-init --tail=30
          echo ""
          echo "=== Auth Service Logs ==="
          docker logs auth_service --tail=50 2>&1 || echo "auth_service not running"
          echo ""
          echo "=== Postgres Logs ==="
          docker logs postgres --tail=20

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          docker compose down -v
          docker system prune -f